<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Truy Cập</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px; /* Increased max-width for a wider layout */
            text-align: center;
        }
        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input[type="text"],
        .input-group input[type="password"] {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        /* Specific styles for the description input box */
        #notOkDescription {
            width: calc(100% - 40px); /* Adjusted width for new padding (20px left + 20px right) */
            padding: 20px; /* Increased padding */
            height: 160px; /* Set a fixed height to make it taller (double of 80px) */
            font-size: 20px; /* Larger font size */
            box-sizing: border-box; /* Include padding in the width calculation */
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #secondScreen {
            display: none;
            text-align: left;
        }
        #statusViewScreen { /* New screen for table view */
            display: none;
            text-align: left;
        }
        .checkbox-group {
            margin-top: 20px;
            margin-bottom: 15px;
            display: flex; /* Use flexbox for better alignment */
            justify-content: center; /* Center the checkboxes */
            align-items: center;
        }
        .checkbox-group label {
            margin-right: 25px; /* Increase space between checkboxes */
            display: flex; /* Align checkbox and text */
            align-items: center;
            font-size: 18px; /* Make label text larger */
        }
        .checkbox-group input[type="checkbox"] {
            transform: scale(1.5); /* Make checkbox larger */
            margin-right: 10px; /* Space between checkbox and its label text */
            width: 20px; /* Ensure consistent size */
            height: 20px; /* Ensure consistent size */
        }
        #notOkInputGroup {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .center-button-container {
            text-align: center; /* Center the button within this container */
            margin-top: 20px;
        }
        /* Styling for the "Xem tình trạng các thành viên khác" button */
        #viewStatusButton {
            width: 80%; /* Make the button longer */
            padding: 15px 20px; /* Increase padding for a larger touch target */
            font-size: 18px; /* Larger font size for the button text */
            margin-bottom: 20px; /* Add some space below the button */
        }
        /* Styling for the loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            z-index: 1001;
            display: none; /* Hidden by default */
        }
        /* Table styles */
        #memberStatusTableContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #memberStatusTableContainer th,
        #memberStatusTableContainer td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #memberStatusTableContainer th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .action-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .action-buttons button {
            width: 45%; /* Adjust width for two buttons */
            padding: 10px 15px;
            font-size: 16px;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="firstScreen">
            <h2>Đăng nhập</h2>
            <div class="input-group">
                <label for="employeeCode">Mã nhân viên (gồm 3 số):</label>
                <input type="text" id="employeeCode" name="employeeCode" maxlength="3"> <!-- Added maxlength -->
            </div>
            <div class="input-group">
                <label for="password">Mật khẩu:</label>
                <input type="password" id="password" name="password">
            </div>
            <button onclick="accessPage()">Truy cập</button>
        </div>

        <div id="secondScreen">
            <div class="center-button-container">
                <button id="viewStatusButton" onclick="viewList()">Xem tình trạng các thành viên khác</button>
            </div>
            <p><strong>Cập nhật tình trạng của bạn:</strong></p>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="statusOk" name="status" value="ok" onchange="handleCheckboxChange(this)"> OK
                </label>
                <label>
                    <input type="checkbox" id="statusNotOk" name="status" value="not_ok" onchange="handleCheckboxChange(this)"> Không OK
                </label>
            </div>
            <div id="notOkInputGroup">
                <label for="notOkDescription">Nếu không OK hãy mô tả ngắn gọn:</label>
                <input type="text" id="notOkDescription" name="notOkDescription">
            </div>
            <div class="center-button-container">
                <button onclick="confirmStatus()">Xác nhận</button>
            </div>
        </div>

        <div id="statusViewScreen"> <!-- New screen for table and navigation -->
            <div id="memberStatusTableContainer" style="margin-top: 0px; text-align: left;">
                <!-- Table will be loaded here -->
            </div>
            <div class="action-buttons">
                <button onclick="reloadTable()">Tải lại</button>
                <button onclick="goBackToUpdateStatus()">Quay lại</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        Đang gửi dữ liệu...
    </div>

    <script>
        const defaultPassword = "ilvprd";

        // Google Form entry IDs
        const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeEzqbzQogPZ6-kpsLL5RrKbl93osdy-lexw4hM9LByUispnQ/formResponse'; // Updated Google Form URL
        const ENTRY_EMPLOYEE_CODE = 'entry.418849416';
        const ENTRY_STATUS = 'entry.811863281'; // This is for the main "Tình trạng" field (now a short answer text field)

        // Google Sheet ID and GID (sheet ID, 0 for first sheet)
        const GOOGLE_SHEET_ID = '1jP0-pUAmDuYlnRvtnckuQVaHFHtjgVbxwzht0p8mcE8';
        const GOOGLE_SHEET_GID = '1306189685'; // Updated to the new GID from your link

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showMessageBox(message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                text-align: center;
                max-width: 300px;
                font-size: 16px;
            `;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button onclick="this.parentNode.remove()" style="background-color: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Đóng</button>
            `;
            document.body.appendChild(messageBox);
        }

        function accessPage() {
            const employeeCode = document.getElementById('employeeCode').value;
            const password = document.getElementById('password').value;

            // Validate employee code
            if (employeeCode.length !== 3 || !/^\d+$/.test(employeeCode)) {
                if (employeeCode.length !== 3) {
                    showMessageBox('Mã nhân viên chỉ gồm 3 số.');
                } else {
                    showMessageBox('Mã nhân viên sai. Vui lòng chỉ nhập số.');
                }
                return; // Stop execution if validation fails
            }

            // Validate password
            if (password === defaultPassword) {
                document.getElementById('firstScreen').style.display = 'none';
                document.getElementById('secondScreen').style.display = 'block';
                // Initialize the state of the description box when second screen is shown
                // Set statusOk to checked by default and trigger change handler
                document.getElementById('statusOk').checked = true;
                handleCheckboxChange(document.getElementById('statusOk'));
            } else {
                showMessageBox('Mật khẩu không đúng. Vui lòng thử lại!');
            }
        }

        async function viewList() {
            // Hide the status update section
            document.getElementById('secondScreen').style.display = 'none';
            // Show the table view section
            document.getElementById('statusViewScreen').style.display = 'block';

            showLoading();

            // Construct the URL to export the Google Sheet as CSV
            const sheetUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GOOGLE_SHEET_GID}`;

            try {
                const response = await fetch(sheetUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const data = parseCsv(csvText); // Parse CSV data

                displayTable(data); // Display data in a table
                hideLoading();
                showMessageBox('Đã tải xong dữ liệu tình trạng thành viên.'); // Only show this message
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu từ Google Sheet:', error);
                hideLoading();
                showMessageBox('Không thể tải dữ liệu tình trạng. Vui lòng kiểm tra kết nối hoặc quyền truy cập Google Sheet.');
            }
        }

        // Function to parse CSV string into an array of objects
        function parseCsv(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length === 0) return [];

            // Simple CSV parsing: split by comma, remove quotes, trim whitespace
            // Assumes no commas within data fields or complex escaping
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const rows = lines.slice(1).map(line => {
                return line.split(',').map(cell => cell.trim().replace(/"/g, ''));
            });

            // Convert to array of objects for easier handling
            return rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || ''; // Handle missing cells gracefully
                });
                return obj;
            });
        }

        // Function to display data in an HTML table
        function displayTable(data) {
            const tableContainer = document.getElementById('memberStatusTableContainer');
            if (!tableContainer) {
                console.error("Table container not found!");
                return;
            }

            // Clear any previous table content
            tableContainer.innerHTML = '';

            if (data.length === 0) {
                tableContainer.innerHTML = '<p>Không có dữ liệu để hiển thị.</p>';
                return;
            }

            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();

            // Create table header row
            const headerRow = thead.insertRow();
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });

            // Create table body rows
            data.forEach(rowData => {
                const row = tbody.insertRow();
                Object.values(rowData).forEach(cellValue => {
                    const td = row.insertCell();
                    td.textContent = cellValue;
                    row.appendChild(td);
                });
            });

            tableContainer.appendChild(table);
        }

        function handleCheckboxChange(changedCheckbox) {
            const statusOk = document.getElementById('statusOk');
            const statusNotOk = document.getElementById('statusNotOk');
            const notOkDescriptionInput = document.getElementById('notOkDescription');

            if (changedCheckbox.id === 'statusOk' && changedCheckbox.checked) {
                statusNotOk.checked = false;
                notOkDescriptionInput.value = '';
                notOkDescriptionInput.readOnly = true;
                notOkDescriptionInput.style.backgroundColor = '#e9e9e9';
            } else if (changedCheckbox.id === 'statusNotOk' && changedCheckbox.checked) {
                statusOk.checked = false;
                notOkDescriptionInput.readOnly = false;
                notOkDescriptionInput.style.backgroundColor = '#fff';
            } else {
                if (!statusOk.checked && !statusNotOk.checked) {
                    notOkDescriptionInput.value = '';
                    notOkDescriptionInput.readOnly = true;
                    notOkDescriptionInput.style.backgroundColor = '#e9e9e9';
                }
            }
        }

        async function confirmStatus() {
            const employeeCode = document.getElementById('employeeCode').value;
            const statusOk = document.getElementById('statusOk').checked;
            const statusNotOk = document.getElementById('statusNotOk').checked;
            const notOkDescription = document.getElementById('notOkDescription').value;

            let statusValueForForm = '';

            if (statusOk) {
                statusValueForForm = 'OK';
            } else if (statusNotOk) {
                if (notOkDescription.trim() === '') {
                    showMessageBox('Vui lòng mô tả ngắn gọn nếu tình trạng Không OK.');
                    return;
                }
                statusValueForForm = 'Không OK - ' + notOkDescription;
            } else {
                showMessageBox('Vui lòng chọn tình trạng của bạn (OK hoặc Không OK).');
                return;
            }

            showLoading();

            const formData = new FormData();
            formData.append(ENTRY_EMPLOYEE_CODE, employeeCode);
            formData.append(ENTRY_STATUS, statusValueForForm);

            try {
                const response = await fetch(GOOGLE_FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });

                showMessageBox('Dữ liệu đã được gửi thành công!');

            } catch (error) {
                console.error('Lỗi khi gửi dữ liệu:', error);
                showMessageBox('Đã xảy ra lỗi khi gửi dữ liệu. Vui lòng thử lại.');
            } finally {
                hideLoading();
            }
        }

        // New function to reload the table data
        function reloadTable() {
            viewList(); // Simply call viewList again to re-fetch and re-display
        }

        // New function to go back to the status update screen
        function goBackToUpdateStatus() {
            document.getElementById('statusViewScreen').style.display = 'none'; // Hide table view
            document.getElementById('secondScreen').style.display = 'block'; // Show status update screen
            document.getElementById('memberStatusTableContainer').innerHTML = ''; // Clear table content
        }
    </script>
</body>
</html>
