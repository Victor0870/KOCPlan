<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kingdom of Chaos</title>
  <style>
    body {
      background: #f0f0f0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    #loading {
      width: 100%;
      height: 100vh;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
    }
    #homepage {
      padding: 20px;
      text-align: center;
      display: none;
    }
    .resource-bar {
      background: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      flex-wrap: wrap;
    }
    .resource-item {
      font-size: 16px;
      font-weight: bold;
    }
    #player-name {
      font-size: 14px;
      margin-top: 5px;
      font-style: italic;
      color: #555;
      width: 100%;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div id="loading">Loading game...</div>

<div id="homepage">
  <div class="resource-bar">
    <div class="resource-item">Food: <span id="food">0</span></div>
    <div class="resource-item">Wood: <span id="wood">0</span></div>
    <div class="resource-item">Iron: <span id="iron">0</span></div>
    <div class="resource-item">Stone: <span id="stone">0</span></div>
    <div id="player-name"></div> <!-- REMARK: Thêm dòng hiển thị tên người chơi -->
  </div>
  <button id="harvestBtn" onclick="harvest()">Thu Hoạch</button> <!-- REMARK: Gán id để disable -->
  <button id="manageBtn" onclick="openTerritory()">Quản Lý Xây Dựng</button>
</div>
<div id="territory-page" style="display:none; padding: 20px; text-align: center;">
  <div class="resource-bar">
    <div class="resource-item">Food: <span id="food2">0</span></div>
    <div class="resource-item">Wood: <span id="wood2">0</span></div>
    <div class="resource-item">Iron: <span id="iron2">0</span></div>
    <div class="resource-item">Stone: <span id="stone2">0</span></div>
  </div>
  <h3>Quản Lý Lãnh Thổ</h3>
  <div id="territory-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;"></div>
  <button onclick="goHome()">Quay Lại</button>
</div>
<!-- REMARK: Thêm SDK PlayFab -->
<script src="https://download.playfab.com/PlayFabClientApi.js"></script>
<script>
PlayFab.settings.titleId = "188E8A";

function updateStorageUI(data) {
  document.getElementById("food").innerText = data.Food || 0;
  document.getElementById("wood").innerText = data.Wood || 0;
  document.getElementById("iron").innerText = data.Iron || 0;
  document.getElementById("stone").innerText = data.Stone || 0;
}

function callCreateStatic(callback) {
  PlayFabClientSDK.ExecuteCloudScript({
    FunctionName: "createInitialStatic"
  }, function () {
    setTimeout(() => callback(), 500);
  }, function () {
    document.getElementById("loading").innerText = "Lỗi tạo dữ liệu!";
  });
}

function loadPlayerStatic(callback) {
  PlayFabClientSDK.GetUserData({}, function (result) {
    const data = result.data?.Data || {};
    const hasStatic = ["CastleLevel", "MaxTerritorySlot", "Territories"]
      .every(k => k in data);

    if (!hasStatic) {
      callCreateStatic(() => loadPlayerStatic(callback));
      return;
    }

    PlayFabClientSDK.GetUserInventory({}, function (inv) {
      const vc = inv.data?.VirtualCurrency || {};
      callback(data, vc);
    }, function () {
      document.getElementById("loading").innerText = "Lỗi tải Inventory!";
    });

  }, function () {
    document.getElementById("loading").innerText = "Lỗi load dữ liệu!";
  });
}

function login() {
  Telegram.WebApp.ready();
  const userId = Telegram.WebApp.initDataUnsafe.user.id.toString();

  PlayFabClientSDK.LoginWithCustomID({
    TitleId: PlayFab.settings.titleId,
    CustomId: userId,
    CreateAccount: true
  }, function () {
    loadPlayerStatic((userData, virtualCurrency) => {
      updateStorageUI({
        Food: userData.Food?.Value,
        Wood: userData.Wood?.Value,
        Iron: userData.Iron?.Value,
        Stone: userData.Stone?.Value
      });

      cachedTerritories = JSON.parse(userData.Territories?.Value || "[]");
      document.getElementById("loading").style.display = "none";
      document.getElementById("homepage").style.display = "block";
    });
  }, function () {
    document.getElementById("loading").innerText = "Lỗi đăng nhập!";
  });
}



function harvest() {
  const btn = document.getElementById("harvestBtn"); // REMARK: disable nút khi bấm
  btn.disabled = true;
  btn.innerText = "Đang thu hoạch...";

  PlayFabClientSDK.ExecuteCloudScript({
    FunctionName: "harvestAllTerritories"
  }, function (res) {
    const storage = res.data?.FunctionResult?.updatedStorage || {};
    updateStorageUI(storage);
    btn.disabled = false;
    btn.innerText = "Thu Hoạch";
  }, function () {
    alert("Lỗi khi thu hoạch!");
    btn.disabled = false;
    btn.innerText = "Thu Hoạch";
  });
}

setTimeout(() => login(), 300);

let cachedTerritories = []; // REMARK: Lưu lại territory để dùng khi chuyển màn

function updateTerritoryUI(territories) {
  const grid = document.getElementById("territory-grid");
  grid.innerHTML = "";

  // Đảm bảo có 9 ô
  const fullTerritories = Array.from({ length: 9 }, (_, i) => territories[i] || { type: 0, level: 0 });

  for (let i = 0; i < 9; i++) {
    const tile = fullTerritories[i];
    const div = document.createElement("div");
    div.style.border = "1px solid #aaa";
    div.style.padding = "10px";
    div.style.background = "#fff";
    div.style.minHeight = "80px";
    div.innerHTML = `<strong>Ô ${i + 1}</strong><br>${
      tile.type > 0
        ? `Type: ${tile.type}<br>Level: ${tile.level}`
        : `<em>Ô đất trống</em>`
    }`;
    grid.appendChild(div);
  }
}


function openTerritory() {
  document.getElementById("homepage").style.display = "none";
  document.getElementById("territory-page").style.display = "block";
  updateTerritoryUI(cachedTerritories);

  // Cập nhật thanh tài nguyên trên giao diện territory
  document.getElementById("food2").innerText = document.getElementById("food").innerText;
  document.getElementById("wood2").innerText = document.getElementById("wood").innerText;
  document.getElementById("iron2").innerText = document.getElementById("iron").innerText;
  document.getElementById("stone2").innerText = document.getElementById("stone").innerText;
}

function goHome() {
  document.getElementById("territory-page").style.display = "none";
  document.getElementById("homepage").style.display = "block";
}
</script>

</body>
</html>
