<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILV Production Dashboard</title>
    <!-- Thư viện Tailwind CSS để tạo giao diện hiện đại -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Thư viện Phosphor Icons để sử dụng các biểu tượng -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling cho các thành phần không thể làm bằng Tailwind */
        .loading-overlay, .message-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
        }
        .message-box-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            text-align: center;
        }
        .status-not-ok-row {
            background-color: #fef3c7 !important; /* màu vàng nhạt */
        }
        .table-scroll-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 4px;
            border: 2px solid #cbd5e1; /* border-slate-300 */
            cursor: pointer;
            position: relative;
        }
        input[type="checkbox"]:checked {
            background-color: #2563eb; /* bg-blue-600 */
            border-color: #2563eb;
        }
        input[type="checkbox"]:checked::after {
            content: '\2713'; /* Dấu check */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-slate-100 flex justify-center items-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xl mx-auto">
        <!-- Màn hình Đăng nhập -->
        <div id="firstScreen" class="text-center">
            <h2 class="text-3xl font-bold mb-6 text-slate-700">Đăng Nhập</h2>
            <div class="space-y-4">
                <div class="input-group text-left">
                    <label for="employeeCode" class="block text-slate-600 font-semibold mb-2">Mã nhân viên (3 số):</label>
                    <input type="text" id="employeeCode" name="employeeCode" maxlength="3"
                           class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <div class="input-group text-left">
                    <label for="password" class="block text-slate-600 font-semibold mb-2">Mật khẩu:</label>
                    <input type="password" id="password" name="password"
                           class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
            </div>
            <button onclick="accessPage()"
                    class="mt-8 w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105">
                Truy cập
            </button>
        </div>

        <!-- Màn hình Cập nhật trạng thái -->
        <div id="secondScreen" class="hidden text-left">
            <div class="flex flex-col sm:flex-row justify-between mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="summaryReportButton" onclick="viewSummaryReport()"
                        class="w-full sm:w-1/2 bg-slate-200 text-slate-800 font-bold py-4 rounded-xl shadow-md hover:bg-slate-300 transition-colors">
                    <i class="ph-bold ph-chart-bar inline-block mr-2"></i> Báo cáo tổng hợp
                </button>
                <button id="detailStatusButton" onclick="viewDetailStatus()"
                        class="w-full sm:w-1/2 bg-slate-200 text-slate-800 font-bold py-4 rounded-xl shadow-md hover:bg-slate-300 transition-colors">
                    <i class="ph-bold ph-list-checks inline-block mr-2"></i> Chi tiết
                </button>
            </div>
            
            <h3 class="text-xl font-bold mb-4 text-slate-700">Cập nhật tình trạng</h3>
            
            <!-- Trạng thái bản thân -->
            <div class="mb-6 bg-slate-50 p-6 rounded-xl border border-slate-200">
                <p class="font-semibold text-slate-600 mb-3">Tình trạng của bạn:</p>
                <div class="flex justify-center space-x-8 mb-4">
                    <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                        <input type="checkbox" id="statusOk" name="status" value="ok" onchange="handleCheckboxChange(this)" class="mr-2"> OK
                    </label>
                    <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                        <input type="checkbox" id="statusNotOk" name="status" value="not_ok" onchange="handleCheckboxChange(this)" class="mr-2"> Không OK
                    </label>
                </div>
                <div class="mt-4">
                    <label for="notOkDescription" class="block text-slate-600 font-semibold mb-2">Nếu không OK, hãy mô tả:</label>
                    <input type="text" id="notOkDescription" name="notOkDescription" placeholder="Mô tả ngắn gọn"
                           class="w-full px-4 py-3 border border-slate-300 rounded-xl bg-slate-200 text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Trạng thái gia đình -->
            <div class="mb-6 bg-slate-50 p-6 rounded-xl border border-slate-200">
                <p class="font-semibold text-slate-600 mb-3">Thành viên gia đình:</p>
                <div class="flex justify-center space-x-8 mb-4">
                    <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                        <input type="checkbox" id="familyOk" name="familyStatus" value="ok" onchange="handleFamilyCheckboxChange(this)" class="mr-2"> OK
                    </label>
                    <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                        <input type="checkbox" id="familyNotOk" name="familyStatus" value="not_ok" onchange="handleFamilyCheckboxChange(this)" class="mr-2"> Không OK
                    </label>
                </div>
                <div class="mt-4">
                    <label for="familyDescription" class="block text-slate-600 font-semibold mb-2">Nếu không OK, hãy mô tả:</label>
                    <input type="text" id="familyDescription" name="familyDescription" placeholder="Mô tả ngắn gọn"
                           class="w-full px-4 py-3 border border-slate-300 rounded-xl bg-slate-200 text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Thiệt hại tài sản -->
            <div class="mb-6 bg-slate-50 p-6 rounded-xl border border-slate-200">
                <p class="font-semibold text-slate-600 mb-3">Thiệt hại tài sản:</p>
                <div class="flex justify-center space-x-8 mb-4">
                    <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                        <input type="checkbox" id="damageNo" name="propertyDamage" value="no" onchange="handleDamageCheckboxChange(this)" class="mr-2"> Không
                    </label>
                    <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                        <input type="checkbox" id="damageYes" name="propertyDamage" value="yes" onchange="handleDamageCheckboxChange(this)" class="mr-2"> Có
                    </label>
                </div>
                <div class="mt-4">
                    <label for="damageDescription" class="block text-slate-600 font-semibold mb-2">Nếu có, hãy mô tả:</label>
                    <input type="text" id="damageDescription" name="damageDescription" placeholder="Mô tả ngắn gọn"
                           class="w-full px-4 py-3 border border-slate-300 rounded-xl bg-slate-200 text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Ngày đi làm -->
            <div class="mb-6 bg-slate-50 p-6 rounded-xl border border-slate-200">
                <p class="font-semibold text-slate-600 mb-3">Có đi làm được vào:</p>
                <div class="flex flex-col space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-lg text-slate-700">Ngày 29.9.2025:</span>
                        <div class="flex space-x-6">
                            <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                                <input type="checkbox" id="work29Yes" name="work29" value="yes" onchange="handleWork29CheckboxChange(this)" class="mr-2"> Có
                            </label>
                            <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                                <input type="checkbox" id="work29No" name="work29" value="no" onchange="handleWork29CheckboxChange(this)" class="mr-2"> Không
                            </label>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-lg text-slate-700">Ngày 30.9.2025:</span>
                        <div class="flex space-x-6">
                            <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                                <input type="checkbox" id="work30Yes" name="work30" value="yes" onchange="handleWork30CheckboxChange(this)" class="mr-2"> Có
                            </label>
                            <label class="flex items-center text-lg text-slate-700 cursor-pointer">
                                <input type="checkbox" id="work30No" name="work30" value="no" onchange="handleWork30CheckboxChange(this)" class="mr-2"> Không
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center">
                <button onclick="confirmStatus()"
                        class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 rounded-xl shadow-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105">
                    Xác nhận
                </button>
            </div>
        </div>

        <!-- Màn hình xem trạng thái -->
        <div id="statusViewScreen" class="hidden text-left">
            <div class="flex justify-between items-center mb-6">
                <button onclick="reloadTable()"
                        class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-semibold hover:bg-slate-300 transition-colors">
                    <i class="ph-bold ph-arrows-clockwise mr-1"></i> Tải lại
                </button>
                <button onclick="goBackToUpdateStatus()"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                    <i class="ph-bold ph-arrow-left mr-1"></i> Quay lại
                </button>
            </div>
            <div id="memberStatusTableContainer" class="bg-white p-4 rounded-xl shadow-md"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-white text-lg font-semibold flex items-center">
            <i class="ph-bold ph-spinner-gap animate-spin mr-2 text-2xl"></i>
            Đang tải dữ liệu...
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBoxOverlay" class="message-box hidden">
        <div id="messageBoxContent" class="message-box-content">
            <p id="messageText" class="text-slate-700 text-lg mb-4"></p>
            <button onclick="hideMessageBox()" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors">Đóng</button>
        </div>
    </div>
    

    <script>
        const defaultPassword = "ilvprd";

        const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeEzqbzQogPZ6-kpsLL5RrKbl93osdy-lexw4hM9LByUispnQ/formResponse';
        const ENTRY_EMPLOYEE_CODE = 'entry.418849416';
        const ENTRY_STATUS = 'entry.811863281';
        const ENTRY_FAMILY_STATUS = 'entry.46892520';
        const ENTRY_PROPERTY_DAMAGE = 'entry.306535075';
        const ENTRY_WORK_29 = 'entry.1788619976';
        const ENTRY_WORK_30 = 'entry.1160663778';

        const GOOGLE_SHEET_ID = '1jP0-pUAmDuYlnRvtnckuQVaHFHtjgVbxwzht0p8mcE8';
        const GOOGLE_SHEET_GID_DETAIL = '1306189685';
        const GOOGLE_SHEET_GID_SUMMARY = '737128637';

        let currentSheetGid = GOOGLE_SHEET_GID_DETAIL;

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        function showMessageBox(message) {
            document.getElementById('messageText').textContent = message;
            document.getElementById('messageBoxOverlay').style.display = 'flex';
        }
        function hideMessageBox() {
            document.getElementById('messageBoxOverlay').style.display = 'none';
        }

        function accessPage() {
            const employeeCode = document.getElementById('employeeCode').value;
            const password = document.getElementById('password').value;
            if (employeeCode.length !== 3 || !/^\d+$/.test(employeeCode)) {
                showMessageBox('Mã nhân viên chỉ gồm 3 số.');
                return;
            }
            if (password === defaultPassword) {
                document.getElementById('firstScreen').style.display = 'none';
                document.getElementById('secondScreen').style.display = 'block';
                // Thiết lập trạng thái mặc định cho các checkbox
                document.getElementById('statusOk').checked = true;
                handleCheckboxChange(document.getElementById('statusOk'));
                document.getElementById('familyOk').checked = true;
                handleFamilyCheckboxChange(document.getElementById('familyOk'));
                document.getElementById('damageNo').checked = true;
                handleDamageCheckboxChange(document.getElementById('damageNo'));
            } else {
                showMessageBox('Mật khẩu không đúng. Vui lòng thử lại!');
            }
        }

        async function fetchAndDisplaySheetData(gid) {
            document.getElementById('secondScreen').style.display = 'none';
            document.getElementById('statusViewScreen').style.display = 'block';
            showLoading();
            const sheetUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
            try {
                const response = await fetch(sheetUrl);
                const csvText = await response.text();
                const data = parseCsv(csvText);
                displayTable(data, gid);
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu:", error);
                showMessageBox("Không thể tải dữ liệu. Vui lòng thử lại!");
            } finally {
                hideLoading();
            }
        }

        function viewSummaryReport() {
            currentSheetGid = GOOGLE_SHEET_GID_SUMMARY;
            fetchAndDisplaySheetData(currentSheetGid);
        }
        function viewDetailStatus() {
            currentSheetGid = GOOGLE_SHEET_GID_DETAIL;
            fetchAndDisplaySheetData(currentSheetGid);
        }
        function parseCsv(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            return lines.slice(1).map(line => {
                const cells = line.split(',').map(c => c.trim().replace(/"/g, ''));
                let obj = {};
                headers.forEach((h, i) => obj[h] = cells[i] || '');
                return obj;
            });
        }
        function displayTable(data, gid) {
            const tableContainer = document.getElementById('memberStatusTableContainer');
            tableContainer.innerHTML = '';
            if (!data.length) {
                tableContainer.innerHTML = '<p class="text-center text-slate-500">Không có dữ liệu để hiển thị.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.classList.add('w-full', 'table-auto');
            
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                th.classList.add('px-4', 'py-2', 'bg-blue-500', 'text-white', 'text-sm', 'font-semibold', 'text-left');
                if (gid === GOOGLE_SHEET_GID_DETAIL) th.classList.add('whitespace-nowrap');
                if (gid === GOOGLE_SHEET_GID_SUMMARY) th.classList.add('text-center');
                headerRow.appendChild(th);
            });
            
            const tbody = table.createTBody();
            data.forEach(rowData => {
                const row = tbody.insertRow();
                row.classList.add('bg-white', 'border-b', 'border-slate-200', 'hover:bg-slate-50');
                if (gid === GOOGLE_SHEET_GID_DETAIL && rowData['Tình trạng'] && rowData['Tình trạng'].startsWith('Không OK')) {
                    row.classList.add('status-not-ok-row');
                }
                Object.values(rowData).forEach(cellValue => {
                    const td = row.insertCell();
                    td.textContent = cellValue;
                    td.classList.add('px-4', 'py-3', 'text-sm', 'text-slate-800');
                    if (gid === GOOGLE_SHEET_GID_DETAIL) td.classList.add('whitespace-nowrap');
                    if (gid === GOOGLE_SHEET_GID_SUMMARY) td.classList.add('text-center');
                });
            });

            const wrapper = document.createElement('div');
            wrapper.classList.add('table-scroll-wrapper');
            wrapper.appendChild(table);
            tableContainer.appendChild(wrapper);
        }

        function handleCheckboxChange(changed) {
            const ok = document.getElementById('statusOk');
            const notOk = document.getElementById('statusNotOk');
            const desc = document.getElementById('notOkDescription');
            if (changed.id === 'statusOk' && changed.checked) {
                notOk.checked = false; 
                desc.value = ''; 
                desc.readOnly = true; 
                desc.classList.remove('bg-white', 'text-slate-800', 'focus:ring-blue-500');
                desc.classList.add('bg-slate-200', 'text-slate-500');
            } else if (changed.id === 'statusNotOk' && changed.checked) {
                ok.checked = false; 
                desc.readOnly = false; 
                desc.classList.remove('bg-slate-200', 'text-slate-500');
                desc.classList.add('bg-white', 'text-slate-800', 'focus:ring-blue-500');
            }
        }
        function handleFamilyCheckboxChange(changed) {
            const ok = document.getElementById('familyOk');
            const notOk = document.getElementById('familyNotOk');
            const desc = document.getElementById('familyDescription');
            if (changed.id === 'familyOk' && changed.checked) {
                notOk.checked = false; 
                desc.value = ''; 
                desc.readOnly = true; 
                desc.classList.remove('bg-white', 'text-slate-800', 'focus:ring-blue-500');
                desc.classList.add('bg-slate-200', 'text-slate-500');
            } else if (changed.id === 'familyNotOk' && changed.checked) {
                ok.checked = false; 
                desc.readOnly = false; 
                desc.classList.remove('bg-slate-200', 'text-slate-500');
                desc.classList.add('bg-white', 'text-slate-800', 'focus:ring-blue-500');
            }
        }
        function handleDamageCheckboxChange(changed) {
            const no = document.getElementById('damageNo');
            const yes = document.getElementById('damageYes');
            const desc = document.getElementById('damageDescription');
            if (changed.id === 'damageNo' && changed.checked) {
                yes.checked = false; 
                desc.value = ''; 
                desc.readOnly = true; 
                desc.classList.remove('bg-white', 'text-slate-800', 'focus:ring-blue-500');
                desc.classList.add('bg-slate-200', 'text-slate-500');
            } else if (changed.id === 'damageYes' && changed.checked) {
                no.checked = false; 
                desc.readOnly = false; 
                desc.classList.remove('bg-slate-200', 'text-slate-500');
                desc.classList.add('bg-white', 'text-slate-800', 'focus:ring-blue-500');
            }
        }
        function handleWork29CheckboxChange(changed) {
            const yes = document.getElementById('work29Yes');
            const no = document.getElementById('work29No');
            if (changed.id === 'work29Yes' && changed.checked) no.checked = false;
            if (changed.id === 'work29No' && changed.checked) yes.checked = false;
        }
        function handleWork30CheckboxChange(changed) {
            const yes = document.getElementById('work30Yes');
            const no = document.getElementById('work30No');
            if (changed.id === 'work30Yes' && changed.checked) no.checked = false;
            if (changed.id === 'work30No' && changed.checked) yes.checked = false;
        }

        async function confirmStatus() {
            const employeeCode = document.getElementById('employeeCode').value;
            const statusOk = document.getElementById('statusOk').checked;
            const statusNotOk = document.getElementById('statusNotOk').checked;
            const notOkDescription = document.getElementById('notOkDescription').value;
            const familyOk = document.getElementById('familyOk').checked;
            const familyNotOk = document.getElementById('familyNotOk').checked;
            const familyDescription = document.getElementById('familyDescription').value;
            const damageNo = document.getElementById('damageNo').checked;
            const damageYes = document.getElementById('damageYes').checked;
            const damageDescription = document.getElementById('damageDescription').value;

            let statusValueForForm = '';
            if (statusOk) statusValueForForm = 'OK';
            else if (statusNotOk) {
                if (!notOkDescription.trim()) { showMessageBox('Vui lòng mô tả nếu Không OK.'); return; }
                statusValueForForm = 'Không OK - ' + notOkDescription;
            } else { showMessageBox('Vui lòng chọn tình trạng của bạn.'); return; }

            let familyStatusValueForForm = '';
            if (familyOk) familyStatusValueForForm = 'OK';
            else if (familyNotOk) {
                if (!familyDescription.trim()) { showMessageBox('Vui lòng mô tả nếu thành viên gia đình Không OK.'); return; }
                familyStatusValueForForm = 'Không OK - ' + familyDescription;
            } else { showMessageBox('Vui lòng chọn tình trạng gia đình.'); return; }

            let propertyDamageValueForForm = '';
            if (damageNo) propertyDamageValueForForm = 'Không';
            else if (damageYes) {
                if (!damageDescription.trim()) { showMessageBox('Vui lòng mô tả nếu có thiệt hại.'); return; }
                propertyDamageValueForForm = 'Có - ' + damageDescription;
            } else { showMessageBox('Vui lòng chọn tình trạng thiệt hại.'); return; }

            let work29Value = '';
            if (document.getElementById('work29Yes').checked) work29Value = 'Có';
            else if (document.getElementById('work29No').checked) work29Value = 'Không';
            else { showMessageBox('Vui lòng chọn câu trả lời cho ngày 29.9.2025.'); return; }

            let work30Value = '';
            if (document.getElementById('work30Yes').checked) work30Value = 'Có';
            else if (document.getElementById('work30No').checked) work30Value = 'Không';
            else { showMessageBox('Vui lòng chọn câu trả lời cho ngày 30.9.2025.'); return; }

            showLoading();
            const formData = new FormData();
            formData.append(ENTRY_EMPLOYEE_CODE, employeeCode);
            formData.append(ENTRY_STATUS, statusValueForForm);
            formData.append(ENTRY_FAMILY_STATUS, familyStatusValueForForm);
            formData.append(ENTRY_PROPERTY_DAMAGE, propertyDamageValueForForm);
            formData.append(ENTRY_WORK_29, work29Value);
            formData.append(ENTRY_WORK_30, work30Value);

            try {
                await fetch(GOOGLE_FORM_URL, { method: 'POST', mode: 'no-cors', body: formData });
                showMessageBox('Dữ liệu đã được gửi thành công!');
            } catch (e) {
                showMessageBox('Đã xảy ra lỗi khi gửi dữ liệu.');
            } finally {
                hideLoading();
            }
        }

        function reloadTable() { fetchAndDisplaySheetData(currentSheetGid); }
        function goBackToUpdateStatus() {
            document.getElementById('statusViewScreen').style.display = 'none';
            document.getElementById('secondScreen').style.display = 'block';
            document.getElementById('memberStatusTableContainer').innerHTML = '';
        }

        // Khởi tạo các trạng thái mặc định ban đầu
        window.onload = function() {
            handleCheckboxChange(document.getElementById('statusOk'));
            handleFamilyCheckboxChange(document.getElementById('familyOk'));
            handleDamageCheckboxChange(document.getElementById('damageNo'));
        };
    </script>
</body>
</html>
