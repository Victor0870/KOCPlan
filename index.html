<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Game Trắc Nghiệm</title>
  <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f0f0f0;
      max-width: 600px;
      margin: auto;
    }

    #home, #loading, #quiz, #leaderboard {
      display: none;
    }

    #home {
      display: block;
    }

    #loggedInOptions {
      display: none;
      margin-top: 20px;
    }

    #loggedInInfo {
      display: none;
      margin-bottom: 10px;
    }

    .answer-button {
      display: block;
      margin: 10px 0;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      color: #000;
    }

    .answer-button:hover {
      background: #e0e0e0;
    }

    .answer-button.selected {
      background-color: #007bff;
      color: white;
      border-color: #0056b3;
    }

    input, button {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    #nextButton {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }

    /* Media queries */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      input, button, .answer-button {
        padding: 8px;
        font-size: 0.9em;
      }
    }

    @media (min-width: 481px) and (max-width: 768px) {
      body {
        padding: 15px;
      }
      input, button, .answer-button {
        padding: 9px;
      }
    }
  </style>
</head>
<body>
  <div id="home">
    <h2>Game Trắc Nghiệm</h2>
    <div id="loggedInInfo">
      Chào <span id="displayName"></span>!
    </div>
    <input id="playerName" placeholder="Tên người chơi">
    <input id="playerCode" placeholder="Mã code 3 số" maxlength="3">
    <button onclick="login()">Đăng Nhập</button>

    <div id="loggedInOptions" style="display: none;">
      <button onclick="startGame()">Bắt Đầu Trắc Nghiệm</button>
      <button onclick="getLeaderboard()">Xem Bảng Xếp Hạng</button>
    </div>
  </div>

  <div id="loading">Đang tải...</div>

  <div id="quiz">
    <div id="questionText"></div>
    <div id="answerList"></div>
    <div>Thời gian: <span id="timer">0</span> giây</div>
    <button id="nextButton" onclick="nextQuestion()">Tiếp tục</button>
  </div>

  <div id="leaderboard">
    <h3>Bảng Xếp Hạng TOP 10</h3>
    <table>
      <thead>
        <tr>
          <th>Hạng</th>
          <th>Tên</th>
          <th>Điểm</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <button onclick="backHome()">Đóng</button>
  </div>

  <script>
    PlayFab.settings.titleId = "13875"; // <----- ĐÃ SỬA TITLE ID
    let quizData = []; // Khởi tạo một mảng rỗng
    let currentIndex = 0;
    let totalScore = 0;
    let timerInterval, startTime;
    let selectedAnswer = null;
    let userAnswers = [];
    let answerButtons = [];
    let isLoggedIn = false; // Biến theo dõi trạng thái đăng nhập

    fetch('questions.json')
      .then(response => response.json())
      .then(data => {
        quizData = data; // Gán dữ liệu câu hỏi đã tải vào biến quizData
        if (isLoggedIn) {
          startGame(); // Nếu đã đăng nhập, bắt đầu game sau khi tải câu hỏi
        }
      })
      .catch(error => {
        console.error('Lỗi khi tải câu hỏi:', error);
        alert('Không thể tải dữ liệu câu hỏi. Vui lòng thử lại sau.');
      });

    function login() {
      const name = document.getElementById("playerName").value.trim();
      const code = document.getElementById("playerCode").value.trim();
      if (name === "" || code.length !== 3 || isNaN(code)) {
        alert("Vui lòng nhập tên và mã code 3 số hợp lệ!");
        return;
      }
      const customId = `${name}_${code}`;
      document.getElementById("home").style.display = "none";
      document.getElementById("loading").style.display = "block";
      PlayFabClientSDK.LoginWithCustomID({
        CustomId: customId,
        CreateAccount: true
      }, function (result) {
        PlayFabClientSDK.UpdateUserTitleDisplayName({ DisplayName: name });
        document.getElementById("loading").style.display = "none";
        document.getElementById("loggedInInfo").style.display = "block";
        document.getElementById("displayName").innerText = name;
        document.getElementById("loggedInOptions").style.display = "block"; // Hiển thị nút tùy chọn sau đăng nhập
        isLoggedIn = true; // Cập nhật trạng thái đăng nhập
        if (quizData.length > 0) {
          startGame(); // Bắt đầu game ngay sau khi đăng nhập và tải xong câu hỏi
        }
      }, function (error) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("home").style.display = "block";
        console.error("Lỗi đăng nhập PlayFab:", error);
        alert("Lỗi đăng nhập: " + error.errorMessage);
      });
    }

    function startGame() {
      if (isLoggedIn && quizData.length > 0) {
        document.getElementById("loggedInOptions").style.display = "none";
        document.getElementById("quiz").style.display = "block";
        shuffleArray(quizData);
        currentIndex = 0;
        totalScore = 0;
        userAnswers = [];
        showQuestion();
      } else if (!isLoggedIn) {
        alert("Vui lòng đăng nhập trước khi bắt đầu!");
      } else if (quizData.length === 0) {
        alert("Đang tải câu hỏi, vui lòng đợi!");
      }
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function showQuestion() {
      const q = quizData[currentIndex];
      document.getElementById("questionText").innerText = `Câu ${currentIndex + 1}: ${q.question}`;
      const answerList = document.getElementById("answerList");
      answerList.innerHTML = "";
      selectedAnswer = null;
      document.getElementById("nextButton").style.display = "none";
      answerButtons = [];

      startTime = Date.now();
      document.getElementById("timer").innerText = "0";
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("timer").innerText = elapsed;
      }, 1000);

      q.answers.forEach((ans, idx) => {
        const btn = document.createElement("button");
        btn.className = "answer-button";
        btn.innerText = ans;
        btn.onclick = () => {
          answerButtons.forEach(b => b.classList.remove("selected"));
          selectedAnswer = idx;
          btn.classList.add("selected");
          document.getElementById("nextButton").style.display = "block";
        };
        answerList.appendChild(btn);
        answerButtons.push(btn);
      });

      document.getElementById("nextButton").innerText = currentIndex < quizData.length - 1 ? "Tiếp tục" : "Kết thúc";
    }

    function nextQuestion() {
      clearInterval(timerInterval);
      if (selectedAnswer === null) {
        alert("Vui lòng chọn một đáp án!");
        return;
      }

      const endTime = Date.now();
      const timeTakenMs = endTime - startTime; // Thời gian trả lời bằng milliseconds
      userAnswers.push(selectedAnswer);

      const currentQuestion = quizData[currentIndex];
      let questionScore = 50; // Điểm cơ bản
      let bonusPoints = 0;

      if (selectedAnswer === currentQuestion.correct) {
        if (timeTakenMs <= 20000) {
          const timeRatio = timeTakenMs / 20000;
          bonusPoints = Math.max(0, Math.floor(50 * (1 - timeRatio)));
        }
      }

      totalScore += questionScore + bonusPoints;

      currentIndex++;
      selectedAnswer = null;
      document.getElementById("nextButton").style.display = "none";

      if (currentIndex < quizData.length) {
        showQuestion();
      } else {
        document.getElementById("quiz").style.display = "none";
        submitResult(totalScore);
      }
    }

    function submitResult(score) {
      document.getElementById("loading").style.display = "block";
      PlayFabClientSDK.ExecuteCloudScript({
        FunctionName: "SubmitQuizScore",
        FunctionParameter: { correct: score }
      }, function (result) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("home").style.display = "block";
        alert("Đã hoàn thành bài trắc nghiệm! Tổng điểm của bạn: " + score + ". Điểm đã được gửi lên bảng xếp hạng.");
      }, function (error) {
        document.getElementById("loading").style.display = "none";
        alert("Lỗi khi nộp điểm: " + error.errorMessage);
        console.error("Lỗi gửi điểm lên PlayFab:", error);
        document.getElementById("home").style.display = "block";
      });
    }

    function getLeaderboard() {
      if (isLoggedIn) {
        document.getElementById("home").style.display = "none";
        document.getElementById("loading").style.display = "block";
        PlayFabClientSDK.GetLeaderboard({
          StatisticName: "QuizScore", // <----- CHÍNH TẢ QUAN TRỌNG: QuizScore
          StartPosition: 0,
          MaxResultsCount: 10
        }, function (result) {
          document.getElementById("loading").style.display = "none";
          const body = document.getElementById("leaderboardBody");
          body.innerHTML = "";
          if (result && result.data && result.data.Leaderboard) {
            result.data.Leaderboard.forEach(entry => {
              const row = document.createElement("tr");
              row.innerHTML = `<td>${entry.Position + 1}</td><td>${entry.DisplayName || entry.PlayFabId}</td><td>${entry.StatValue}</td>`;
              body.appendChild(row);
            });
            document.getElementById("leaderboard").style.display = "block";
          } else {
            alert("Không thể tải bảng xếp hạng.");
            document.getElementById("home").style.display = "block";
          }
        }, function (error) {
          document.getElementById("loading").style.display = "none";
          alert("Lỗi khi tải bảng xếp hạng.");
          console.error("Lỗi lấy bảng xếp hạng PlayFab:", error);
          document.getElementById("home").style.display = "block";
        });
      } else {
        alert("Vui lòng đăng nhập trước khi xem bảng xếp hạng!");
      }
    }

    function backHome() {
      document.getElementById("leaderboard").style.display = "none";
      document.getElementById("home").style.display = "block";
    }
  </script>
</body>
</html>
