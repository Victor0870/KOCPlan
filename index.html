<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Game Trắc Nghiệm</title>
  <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; max-width: 600px; margin: auto; }
    #quiz, #loading, #leaderboard { display: none; }
    .answer { display: block; margin: 10px 0; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 6px; }
    .answer:hover { background: #e0e0e0; }
    input, button { padding: 10px; margin-top: 10px; width: 100%; box-sizing: border-box; }
    button { background: #007bff; color: white; border: none; border-radius: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
  </style>
</head>
<body>
  <div id="home">
    <h2>Game Trắc Nghiệm</h2>
    <input id="playerName" placeholder="Tên người chơi">
    <input id="playerCode" placeholder="Mã code 3 số" maxlength="3">
    <button onclick="login()">Bắt đầu</button>
    <button onclick="getLeaderboard()">Xem Bảng Xếp Hạng</button>
  </div>

  <div id="loading">Đang tải câu hỏi...</div>

  <div id="quiz">
    <div id="questionText"></div>
    <div id="answerList"></div>
    <div>Thời gian: <span id="timer">0</span> giây</div>
    <button id="nextButton" onclick="nextQuestion()">Next</button>
  </div>

  <div id="leaderboard">
    <h3>Bảng Xếp Hạng TOP 10</h3>
    <table>
      <thead><tr><th>Hạng</th><th>Tên</th><th>Điểm</th></tr></thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
    <button onclick="backHome()">Đóng</button>
  </div>

  <script>
    PlayFab.settings.titleId = "13875";
    let quizData = [];
    let currentIndex = 0;
    let totalScore = 0;
    let timerInterval, startTime;

    function login() {
      const name = document.getElementById("playerName").value.trim();
      const code = document.getElementById("playerCode").value.trim();
      if (name === "" || code.length !== 3 || isNaN(code)) {
        alert("Nhập tên và mã 3 số!");
        return;
      }
      const customId = `${name}_${code}`;
      PlayFabClientSDK.LoginWithCustomID({
        CustomId: customId,
        CreateAccount: true
      }, function () {
        PlayFabClientSDK.UpdateUserTitleDisplayName({ DisplayName: name });
        document.getElementById("home").style.display = "none";
        document.getElementById("loading").style.display = "block";
        loadQuiz();
      }, function (err) {
        alert("Lỗi đăng nhập");
      });
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

   function loadQuiz() {
  PlayFabClientSDK.GetTitleData({ Keys: ["quiz"] }, function (result) {
    if (!result.Data || !result.Data.quiz) {
      alert("Không tìm thấy dữ liệu câu hỏi trong TitleData.");
      console.error("Data trả về:", result.Data);
      return;
    }

    try {
      quizData = JSON.parse(result.Data.quiz);
    } catch (e) {
      alert("Lỗi JSON không hợp lệ trong TitleData.");
      console.error("Lỗi phân tích JSON:", e);
      return;
    }

    shuffleArray(quizData);
    currentIndex = 0;
    totalScore = 0;
    document.getElementById("loading").style.display = "none";
    document.getElementById("quiz").style.display = "block";
    showQuestion();
  }, function (error) {
    alert("Lỗi khi tải câu hỏi từ PlayFab.");
    console.error("Lỗi API:", error);
  });
}


    function showQuestion() {
      const q = quizData[currentIndex];
      document.getElementById("questionText").innerText = `Câu ${currentIndex + 1}: ${q.question}`;
      const answerList = document.getElementById("answerList");
      answerList.innerHTML = "";

      startTime = Date.now();
      document.getElementById("timer").innerText = "0";
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("timer").innerText = elapsed;
      }, 200);

      q.answers.forEach((ans, idx) => {
        const btn = document.createElement("button");
        btn.className = "answer";
        btn.innerText = ans;
        btn.onclick = () => {
          clearInterval(timerInterval);
          const elapsed = (Date.now() - startTime) / 1000;
          let bonus = 0;
          if (elapsed <= 5) bonus = 50;
          else if (elapsed <= 10) bonus = 40;
          else if (elapsed <= 20) bonus = 20;
          else if (elapsed <= 30) bonus = 10;
          const base = (idx === q.correct) ? 50 : 0;
          totalScore += base + (idx === q.correct ? bonus : 0);
          btn.style.backgroundColor = idx === q.correct ? "lightgreen" : "salmon";
        };
        answerList.appendChild(btn);
      });

      document.getElementById("nextButton").innerText = currentIndex < quizData.length - 1 ? "Next" : "Kết thúc";
    }

    function nextQuestion() {
      currentIndex++;
      if (currentIndex < quizData.length) showQuestion();
      else {
        clearInterval(timerInterval);
        document.getElementById("quiz").style.display = "none";
        submitResult(totalScore);
      }
    }

    function submitResult(score) {
      PlayFabClientSDK.ExecuteCloudScript({
        FunctionName: "SubmitQuizScore",
        FunctionParameter: { correct: score }
      }, function () {
        alert("Hoàn thành! Điểm: " + score);
        document.getElementById("home").style.display = "block";
      });
    }

    function getLeaderboard() {
      PlayFabClientSDK.GetLeaderboard({
        StatisticName: "QuizScore",
        StartPosition: 0,
        MaxResultsCount: 10
      }, function (result) {
        const body = document.getElementById("leaderboardBody");
        body.innerHTML = "";
        result.data.Leaderboard.forEach(entry => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${entry.Position + 1}</td><td>${entry.DisplayName || entry.PlayFabId}</td><td>${entry.StatValue}</td>`;
          body.appendChild(row);
        });
        document.getElementById("home").style.display = "none";
        document.getElementById("leaderboard").style.display = "block";
      });
    }

    function backHome() {
      document.getElementById("leaderboard").style.display = "none";
      document.getElementById("home").style.display = "block";
    }
  </script>
</body>
</html>
