
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kingdom of Chaos</title>
  <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #fff; }
    #loading { font-size: 20px; margin-bottom: 20px; }
    .resource-item { margin: 10px 0; }
  </style>
</head>
<body>

<div id="loading">Loading game...</div>

<div id="homepage" style="display:none;">
  <div class="resource-item">Food: <span id="food">0</span></div>
  <div class="resource-item">Wood: <span id="wood">0</span></div>
  <div class="resource-item">Iron: <span id="iron">0</span></div>
  <div class="resource-item">Stone: <span id="stone">0</span></div>
  <button onclick="harvest()">Thu Hoạch</button>
</div>

<script>
PlayFab.settings.titleId = "188E8A";

function updateStorageUI(data) {
  document.getElementById("food").innerText = data.Food || 0;
  document.getElementById("wood").innerText = data.Wood || 0;
  document.getElementById("iron").innerText = data.Iron || 0;
  document.getElementById("stone").innerText = data.Stone || 0;
}

function callCreateStatic(callback) {
  PlayFabClientSDK.ExecuteCloudScript({
    FunctionName: "createInitialStatic"
  }, function () {
    setTimeout(() => callback(), 500);
  }, function () {
    document.getElementById("loading").innerText = "Lỗi tạo dữ liệu!";
  });
}

function loadPlayerStatic(callback) {
  PlayFabClientSDK.GetUserData({}, function (result) {
    const data = result.data?.Data || {};
    const hasStatic = ["CastleLevel", "MaxTerritorySlot", "Territories"]
      .every(k => k in data);

    if (!hasStatic) {
      callCreateStatic(() => loadPlayerStatic(callback));
      return;
    }

    PlayFabClientSDK.GetUserInventory({}, function (inv) {
      const vc = inv.data?.VirtualCurrency || {};
      callback(data, vc);
    }, function () {
      document.getElementById("loading").innerText = "Lỗi tải Inventory!";
    });

  }, function () {
    document.getElementById("loading").innerText = "Lỗi load dữ liệu!";
  });
}

function login() {
  let userId;
  if (typeof Telegram !== "undefined" && Telegram.WebApp?.initDataUnsafe?.user?.id) {
    userId = Telegram.WebApp.initDataUnsafe.user.id;
  } else {
    userId = "web_" + Math.floor(Math.random() * 1000000); // fallback ID for browser
  }

  PlayFabClientSDK.LoginWithCustomID({
    TitleId: PlayFab.settings.titleId,
    CustomId: userId.toString(),
    CreateAccount: true
  }, function () {
    loadPlayerStatic((userData, virtualCurrency) => {
      updateStorageUI({
        Food: userData.Food?.Value,
        Wood: userData.Wood?.Value,
        Iron: userData.Iron?.Value,
        Stone: userData.Stone?.Value
      });

      document.getElementById("loading").style.display = "none";
      document.getElementById("homepage").style.display = "block";
    });
  }, function () {
    document.getElementById("loading").innerText = "Lỗi đăng nhập!";
  });
}

function harvest() {
  PlayFabClientSDK.ExecuteCloudScript({
    FunctionName: "harvestAllTerritories"
  }, function (res) {
    const storage = res.data?.FunctionResult?.updatedStorage || {};
    updateStorageUI(storage);
  }, function () {
    alert("Lỗi khi thu hoạch!");
  });
}

setTimeout(() => login(), 300);
</script>

</body>
</html>
