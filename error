private async void HandleRemoveMaterialConfirmed(string materialId)
{
    Debug.Log($"Đang xử lý yêu cầu xóa vật tư với ID: {materialId} khỏi Task ID: {_currentTaskId}");

    var localUsageRecord = E_UsageHistory.FindEntity(e => e.f_materialId == materialId && e.f_taskId == _currentTaskId);
    var temporaryUsageRecord = _temporaryTaskMaterials.ContainsKey(materialId) ? _temporaryTaskMaterials[materialId] as Dictionary<string, object> : null;

    if (localUsageRecord != null)
    {
        Debug.Log("Đã tìm thấy bản ghi sử dụng cục bộ.");
        if (!string.IsNullOrEmpty(localUsageRecord.f_firestoreDocId))
        {
            await _materialDataHandler.DeleteMaterialUsage(_currentTaskId, localUsageRecord.f_firestoreDocId);
            Debug.Log($"Đã gửi yêu cầu xóa bản ghi Firestore với ID: {localUsageRecord.f_firestoreDocId}");
        }
        else
        {
            Debug.LogWarning("Không tìm thấy firestoreDocId, chỉ xóa bản ghi cục bộ.");
        }

        localUsageRecord.Delete();
        SaveData.Save();
        Debug.Log("Đã xóa bản ghi sử dụng vật tư cục bộ.");

        var localMaterial = E_SparePart.FindEntity(entity => entity.f_No.ToString() == materialId);
        if (localMaterial != null)
        {
            // Tăng tồn kho trở lại
            localMaterial.f_Stock += localUsageRecord.f_quantity; 
            await synchronizerToFirebase.SynchronizeSingleSparePart(localMaterial);
            SaveData.Save();
            Debug.Log("Đã lưu dữ liệu vào bộ nhớ cục bộ sau khi xóa vật tư và tăng stock.");
        }

        _materialUIManager.RemoveTemporaryMaterial(materialId);
        Debug.Log("Đã cập nhật giao diện người dùng.");
    }
    else if (temporaryUsageRecord != null)
    {
        Debug.Log("Đã tìm thấy bản ghi tạm thời. Tiến hành xóa.");
        _temporaryTaskMaterials.Remove(materialId);
        _materialUIManager.RemoveTemporaryMaterial(materialId);
        Debug.Log("Đã xóa bản ghi tạm thời và cập nhật giao diện.");
    }
    else
    {
        Debug.LogWarning("Không tìm thấy bản ghi sử dụng vật tư cục bộ hoặc tạm thời để xóa.");
    }
}
